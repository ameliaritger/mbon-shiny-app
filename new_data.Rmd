---
title: "Untitled"
author: "Amelia Ritger"
date: "6/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(tidyverse)
library(janitor)
library(sf)
library(tmap)
library(vegan)
library(gt)
```

## Organize the data 
```{r}
#Read in data
reef1 <- read_csv("MBON_photo_quadrat_point_cover_20200612.csv")
```


```{r}
mpa_sites <- c("Anacapa Landing", "Arroyo Quemado", "Carpinteria", "Cathedral Cove", "Gull Island", "Isla Vista", "Naples", "West End Cat Rock")

pal <- c(
  "Annelida" = "#D2691E",
  "Arthropoda" = "#CDCDB4", 
  "Chlorophyta" = "#A2CD5A", 
  "Chordata" = "#FFB90F",
  "Cnidaria" = "#B4CDCD", 
  "Echinodermata" = "#FF6347", 
  "Ectoprocta" = "#FF8C00",
  #"Fish" = "#CD3700",
  #"Heterokontophyta" = "#8B814C",
  "Ochrophyta" = "#8B814C",
  "Mollusca" = "#708090",
  "Phoronida" = "#FAFAD2",
  "Porifera" = "#EEDC82",
  "Rhodophyta" = "#DB7093"
)
```


```{r}
#Tidy up the data
reef1_tidy <- reef1 %>%
  clean_names() %>% #standardize names
  #group_by(location) %>% #group by location to get average lat/long values for each location
  #mutate(latitude=head(lat,1), longitude=head(long,1)) %>% #get average lat/long values (because that's how that works...)
  #ungroup() %>% #really important, we don't want to confuse R!
  #pivot_longer("annelida_cirriformia_luxuriosa":"substrate_amphipod_tube_complex") %>%  #make long form
  #separate(name, into="phylum", sep="_", remove=FALSE) %>% #Add column for phylum name
  #mutate(vectorized_name=str_split(name, pattern="_")) %>% #In case this is useful...
  filter(!category=="no data") %>% #remove values related to data collection issue
  filter(!category=="substrate") %>% #remove substrate values
  rename(value = percent_cover,
         latitude = lat,
         longitude = lon) %>% 
  group_by(location) %>% #group by location to get one lat/long value for each location
  mutate(latitude=head(latitude,1), 
         longitude=head(longitude,1)) %>%  #get one value for lat/long (because that's how that works...)
  ungroup() %>% #Important!
  mutate(common_name = str_replace_all(common_name, pattern="\\.", " ")) %>% #replace . in common names with a space
  mutate(species_new = ifelse(is.na(species)=="TRUE", common_name, species), #replace NAs with common name
         genus_new = ifelse(is.na(genus)=="TRUE", common_name, genus),
         order_new = ifelse(is.na(order)=="TRUE", common_name, order),
         species_new = ifelse(is.na(species_new)=="TRUE", paste(genus_new, "spp."), #if no common name, make species name "Genus spp."
                              ifelse(species_new==genus_new, species_new, paste(genus_new,species_new)))) %>% #for those organisms with only a common name identifier for genus and species, only use the common name in the species_new column (to avoid duplication)
  #filter(is.na(species_new)=="TRUE")
  #filter(str_detect(species_new, "spp."))
    mutate(mpa = ifelse(location %in% c(mpa_sites), "mpa", "unprotected")) #add column for MPA versus non-MPA sites

sort(unique(reef1_tidy$location))

reef1_location <- reef1_tidy %>% 
  distinct(location, latitude, longitude)

reef1_vegan <- reef1_tidy %>% #named so because of the vegan package!
  group_by(location,species_new, mpa) %>% #group by location, then lat/long
  summarize(mean_count = mean(value)) %>%  #get the mean count
  select(location, species_new, mpa, mean_count) %>% 
  ungroup()

#Calculate species diversity and richness for each site
reef1_vegan_subset <- reef1_vegan %>%
  pivot_wider(names_from=species_new, values_from=mean_count) %>% 
  replace(is.na(.), 0) %>% #replace all NA values with zeros
  select(`Abeitinaria spp.`:`Zonaria farlowii`)

diversity1 <- diversity(reef1_vegan_subset)
richness1 <- specnumber(reef1_vegan_subset)

reef1_vegan <- reef1_location %>% 
  add_column(diversity1, richness1)
```

Diversity tab troubleshooting
```{r}
coord_sbc <- st_bbox(reef1_vegan %>%
                       st_as_sf(coords=c("longitude", "latitude"), crs=4326))

reef1_vegan_sf <- reef1_vegan %>% 
    st_as_sf(coords=c("longitude", "latitude"), crs=4326)  #create sticky geometry for lat/long

#create index map
reef1_map_index <- tm_basemap("Esri.WorldImagery") +
    tm_shape(reef1_vegan_sf, bbox = coord_sbc) +
    tm_symbols(id="location", col = "richness1", size = "richness1", scale=2, #point size corresponds to value
               palette = "inferno", contrast = c(1,0.5)) #set viridis palette to match plot
  
tmap_mode("view") #view = interactive
reef1_map_index
```

Community tab troubleshooting
```{r}
#generate reactive summary data
reef1_summary_community <- reef1_tidy %>%
    filter(value > "0") %>% #filter out species not present
    filter(location=="Naples", #filter for location of interest
           str_detect(orientation,pattern="l")) %>% #filter for orientation of interest
    group_by(phylum) %>% #group by phylum
    summarize(mean_count = mean(value), #get the mean count
              median_count = median(value), #get the median count
              sd_count = sd(value), #get the s.d. count
              iqr = IQR(value), #get the interquartile range for the count
              sample_size = n())

#generate plot
  ggplot(data=reef1_summary_community, aes(x=reorder(phylum, sample_size), #order bars by descending value
                                  y=sample_size, 
                                  fill=phylum)) + #color bars by phylum identity
    geom_col() +
    scale_fill_manual(values=pal, limits=names(pal), guide=FALSE) + #color bars by phylum color palette, remove legend
    coord_flip() +
    ylab(paste("Number of plots")) +
    xlab("Phylum") +
    theme_minimal() +
    theme(text = element_text(size = 15))
```


```{r}
#Sankey diagram
#Prep data
reef_top <- reef1_summary_community %>% 
  group_by(phylum) %>% 
  tally(sample_size) %>% 
  top_n(2)

reef_sankey <- reef1_tidy %>%
  filter(value > "0") %>% #filter out species not present
  filter(location=="Naples", #filter for location of interest
           str_detect(orientation,pattern="l")) %>% #filter for orientation of interest
  group_by(phylum, order_new, species_new) %>%
  summarize(`mean abundance` = mean(value)) %>% 
  filter(phylum %in% c(reef_top$phylum)) %>% 
  select(phylum, order_new, species_new, `mean abundance`)

reef_names <- reef_sankey %>% 
  select(phylum, order_new, species_new)

node_names <- factor(sort(unique(as.character(unname(unlist(reef_names))))))

nodes <- data.frame(name = node_names)

links <- data.frame(source = match(c(reef_sankey$phylum,reef_sankey$order_new), node_names) - 1,
             target = match(c(reef_sankey$order_new, reef_sankey$species_new), node_names) - 1,
             value = reef_sankey$`mean abundance`,
             group = c(reef_sankey$phylum, reef_sankey$order_new)) %>% 
  filter(!str_detect(group, pattern=" "))

pal_noo <- as.data.frame(pal)
pal_noo$pal <- as.character(pal)
pal_noo <- pal_noo %>% 
  mutate(phylum = row.names(pal_noo))

nodes2 <- nodes %>% 
  rename(phylum=name)
links_new <- left_join(nodes2, pal_noo, by="phylum")

reef1_tidy_org <- merge(reef1_tidy, pal_noo, by="phylum")
reef_palette <- reef1_tidy_org %>% 
  select(species_new, genus_new, order_new, phylum, pal) %>% 
  distinct(species_new, .keep_all=TRUE) %>% 
  pivot_longer(species_new:phylum) %>% 
  rename(color=pal,
         group=name,
         phylum=value) %>% 
  distinct(phylum, .keep_all=TRUE)

links_noo <- left_join(links_new, reef_palette, by = "phylum")

#mutate(color = ifelse(group %in% pal_noo$organism, pal_noo$pal, "random"))
#sample(pal, 60, replace=TRUE))

#Set color palette that can be recognized by sankeyNetwork
my_color <- 'd3.scaleOrdinal() .domain(["Annelida","Arthropoda","Chlorophyta","Chordata","Cnidaria","Echinodermata","Ectoprocta","Fish","Heterokontophyta","Mollusca","Phoronida","Porifera","Rhodophyta"]) .range(["#D2691E", "#CDCDB4", "#3CB371", "#EE9A00","#6CA6CD", "#FF6347", "#F4A460", "#CD3700", "#6B8E23", "#708090", "#FAFAD2","#EEDD82", "#DB7093"])'

colors2 <- paste(links_noo$color, collapse = '", "')
organism <- paste(links_noo$phylum, collapse = '", "')
colorJS2 <- paste('d3.scaleOrdinal(["', colors2, '"])')


colorJS3 <- paste('d3.scaleOrdinal() .domain(["',organism,'"]) .range(["',colors2,'"])')
                  
#Sankey diagram
sankeyNetwork(Links = links, Nodes = nodes,
              Source = "source", Target = "target",
              Value = "value", NodeID = "name",
              fontSize = 12, nodeWidth = 30,
              colourScale = colorJS3,
              LinkGroup="group", NodeGroup = NULL)

```


# TO DO:
- group all of the common names together (like anemones, bryozoans)
- fix Community tab

```{r}
data <- structure(list(nodes = structure(list(name = c("Source0", "Source1", 
"Source2", "Source3", "Source4", "Source5", "Source6", "Source7", 
"Source8", "Source9", "Source10", "Target11", "Target12", "Target13", 
"Target14", "Target15", "Target16", "Target17", "Target18", "Target19", 
"Target20", "Target21", "Target22", "Target23", "Target24", "Target25", 
"Target26", "Target27", "Target28", "Target29", "Target30", "Target31", 
"Target32", "Target33", "Target34", "Target35", "Target36", "Target37", 
"Target38", "Target39", "Target40", "Target41", "Target42", "Target43", 
"Target44", "Target45", "Target46", "Target47"), group = c("Source0", 
"Source1", "Source2", "Source3", "Source4", "Source5", "Source6", 
"Source7", "Source8", "Source9", "Source10", "Target", "Target", 
"Target", "Target", "Target", "Target", "Target", "Target", "Target", 
"Target", "Target", "Target", "Target", "Target", "Target", "Target", 
"Target", "Target", "Target", "Target", "Target", "Target", "Target", 
"Target", "Target", "Target", "Target", "Target", "Target", "Target", 
"Target", "Target", "Target", "Target", "Target", "Target", "Target"
), colors = c("#9E0142", "#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", 
"#FFFFBF", "#E6F598", "#ABDDA4", "#66C2A5", "#3288BD", "#5E4FA2", 
"#969696", "#969696", "#969696", "#969696", "#969696", "#969696", 
"#969696", "#969696", "#969696", "#969696", "#969696", "#969696", 
"#969696", "#969696", "#969696", "#969696", "#969696", "#969696", 
"#969696", "#969696", "#969696", "#969696", "#969696", "#969696", 
"#969696", "#969696", "#969696", "#969696", "#969696", "#969696", 
"#969696", "#969696", "#969696", "#969696", "#969696", "#969696", 
"#969696")), .Names = c("name", "group", "colors"), row.names = c(NA, 
-48L), class = "data.frame"), links = structure(list(source = c(0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 
3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 
6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 
8, 9, 9, 9, 9, 9, 9, 9, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10
), target = c(11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 
23, 13, 18, 15, 11, 12, 24, 21, 25, 26, 27, 19, 28, 16, 22, 29, 
30, 31, 32, 18, 16, 15, 13, 27, 29, 19, 33, 34, 31, 35, 21, 24, 
11, 30, 36, 28, 37, 38, 39, 40, 26, 41, 11, 12, 15, 18, 19, 14, 
13, 16, 27, 34, 20, 22, 25, 12, 27, 16, 18, 13, 11, 12, 11, 14, 
27, 21, 16, 18, 22, 13, 15, 19, 16, 11, 12, 39, 12, 14, 18, 11, 
42, 43, 44, 13, 11, 18, 15, 12, 19, 45, 31, 16, 20, 46, 40, 47, 
11, 12, 18, 16, 14, 19, 15, 11, 12, 16, 13, 18, 14, 34, 31, 15
), value = c(5.8, 3.2, 5, 2.4, 2.5, 2.7, 3.5, 2.5, 3.5, 1.4, 
2.9, 2.4, 1.3, 12.1, 7.4, 5, 11.2, 5.6, 6.4, 8.8, 2.6, 3.5, 7, 
10, 4.5, 6, 6.5, 5.8, 5.4, 6.2, 8.9, 5.5, 4.8, 3.4, 6.5, 5, 4, 
6.4, 7.3, 4.4, 4.2, 1.7, 5.1, 3.6, 6.4, 3.4, 2.5, 2.6, 2.3, 2.3, 
3.2, 1.6, 1.7, 3.7, 8, 4.4, 3.1, 4.1, 5.9, 2.8, 5, 3.2, 3.7, 
3.4, 1.8, 3.2, 1.2, 4.1, 5.2, 4.5, 4.8, 7.1, 7.3, 4.6, 8.4, 3.4, 
5.2, 6.1, 4.3, 4.5, 4.5, 6.5, 2.8, 6.3, 5.3, 8.2, 3.8, 4.3, 4.2, 
3.4, 5.4, 7.9, 1.2, 1.4, 1.4, 6.6, 6.8, 4.2, 2.9, 3.1, 5.3, 2.6, 
3.2, 2.9, 1.7, 1.9, 1.4, 8, 8, 4, 5, 4.3, 2.9, 6.9, 3, 8.7, 4.5, 
4.2, 6.6, 4.4, 2.7, 4.4, 4.3, 2.8), group = c("Source0", "Source0", 
"Source0", "Source0", "Source0", "Source0", "Source0", "Source0", 
"Source0", "Source0", "Source0", "Source0", "Source0", "Source1", 
"Source1", "Source1", "Source1", "Source1", "Source1", "Source1", 
"Source1", "Source1", "Source1", "Source1", "Source1", "Source1", 
"Source1", "Source1", "Source1", "Source1", "Source1", "Source2", 
"Source2", "Source2", "Source2", "Source2", "Source2", "Source2", 
"Source2", "Source2", "Source2", "Source2", "Source2", "Source2", 
"Source2", "Source2", "Source2", "Source2", "Source2", "Source2", 
"Source2", "Source2", "Source2", "Source2", "Source3", "Source3", 
"Source3", "Source3", "Source3", "Source3", "Source3", "Source3", 
"Source3", "Source3", "Source3", "Source3", "Source3", "Source4", 
"Source4", "Source4", "Source4", "Source4", "Source4", "Source5", 
"Source5", "Source5", "Source5", "Source5", "Source5", "Source5", 
"Source5", "Source5", "Source5", "Source5", "Source6", "Source6", 
"Source6", "Source6", "Source7", "Source7", "Source7", "Source7", 
"Source7", "Source7", "Source7", "Source8", "Source8", "Source8", 
"Source8", "Source8", "Source8", "Source8", "Source8", "Source8", 
"Source8", "Source8", "Source8", "Source9", "Source9", "Source9", 
"Source9", "Source9", "Source9", "Source9", "Source9", "Source10", 
"Source10", "Source10", "Source10", "Source10", "Source10", "Source10", 
"Source10", "Source10")), .Names = c("source", "target", "value", 
"group"), row.names = c(NA, -124L), class = "data.frame")), .Names = c("nodes", 
"links"))

colors <- paste(data$nodes$colors, collapse = '", "')
colorJS <- paste('d3.scaleOrdinal(["', colors, '"])')

```

