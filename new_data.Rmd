---
title: "Untitled"
author: "Amelia Ritger"
date: "6/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(tidyverse)
library(janitor)
library(sf)
library(tmap)
library(vegan)
library(gt)
```

## Organize the data 
```{r}
#Read in data
reef1 <- read_csv("MBON_photo_quadrat_point_cover_20200612.csv")
```


```{r}
mpa_sites <- c("Anacapa Landing", "Arroyo Quemado", "Carpinteria", "Cathedral Cove", "Gull Island", "Isla Vista", "Naples", "West End Cat Rock")

pal <- c(
  "Annelida" = "#D2691E",
  "Arthropoda" = "#CDCDB4", 
  "Chlorophyta" = "#A2CD5A", 
  "Chordata" = "#FFB90F",
  "Cnidaria" = "#B4CDCD", 
  "Echinodermata" = "#FF6347", 
  "Ectoprocta" = "#FF8C00",
  #"Fish" = "#CD3700",
  #"Heterokontophyta" = "#8B814C",
  "Ochrophyta" = "#8B814C",
  "Mollusca" = "#708090",
  "Phoronida" = "#FAFAD2",
  "Porifera" = "#EEDC82",
  "Rhodophyta" = "#DB7093"
)
```


```{r}
#Tidy up the data
reef1_tidy <- reef1 %>%
  clean_names() %>% #standardize names
  #group_by(location) %>% #group by location to get average lat/long values for each location
  #mutate(latitude=head(lat,1), longitude=head(long,1)) %>% #get average lat/long values (because that's how that works...)
  #ungroup() %>% #really important, we don't want to confuse R!
  #pivot_longer("annelida_cirriformia_luxuriosa":"substrate_amphipod_tube_complex") %>%  #make long form
  #separate(name, into="phylum", sep="_", remove=FALSE) %>% #Add column for phylum name
  #mutate(vectorized_name=str_split(name, pattern="_")) %>% #In case this is useful...
  filter(!category=="no data") %>% #remove values related to data collection issue
  filter(!category=="substrate") %>% #remove substrate values
  rename(value = percent_cover,
         latitude = lat,
         longitude = lon) %>% 
  group_by(location) %>% #group by location to get one lat/long value for each location
  mutate(latitude=head(latitude,1), 
         longitude=head(longitude,1)) %>%  #get one value for lat/long (because that's how that works...)
  ungroup() %>% #Important!
  mutate(common_name = str_replace_all(common_name, pattern="\\.", " ")) %>% #replace . in common names with a space
  mutate(species_new = ifelse(is.na(species)=="TRUE", common_name, species), #replace NAs with common name
         genus_new = ifelse(is.na(genus)=="TRUE", common_name, genus),
         order_new = ifelse(is.na(order)=="TRUE", common_name, order),
         species_new = ifelse(is.na(species_new)=="TRUE", paste(genus_new, "spp."), #if no common name, make species name "Genus spp."
                              ifelse(species_new==genus_new, species_new, paste(genus_new,species_new)))) %>% #for those organisms with only a common name identifier for genus and species, only use the common name in the species_new column (to avoid duplication)
  #filter(is.na(species_new)=="TRUE")
  #filter(str_detect(species_new, "spp."))
    mutate(mpa = ifelse(location %in% c(mpa_sites), "mpa", "unprotected")) #add column for MPA versus non-MPA sites

sort(unique(reef1_tidy$location))

reef1_location <- reef1_tidy %>% 
  distinct(location, latitude, longitude)

reef1_vegan <- reef1_tidy %>% #named so because of the vegan package!
  group_by(location,species_new, mpa) %>% #group by location, then lat/long
  summarize(mean_count = mean(value)) %>%  #get the mean count
  select(location, species_new, mpa, mean_count) %>% 
  ungroup()

#Calculate species diversity and richness for each site
reef1_vegan_subset <- reef1_vegan %>%
  pivot_wider(names_from=species_new, values_from=mean_count) %>% 
  replace(is.na(.), 0) %>% #replace all NA values with zeros
  select(`Abeitinaria spp.`:`Zonaria farlowii`)

diversity1 <- diversity(reef1_vegan_subset)
richness1 <- specnumber(reef1_vegan_subset)

reef1_vegan <- reef1_location %>% 
  add_column(diversity1, richness1)
```

Diversity tab troubleshooting
```{r}
coord_sbc <- st_bbox(reef1_vegan %>%
                       st_as_sf(coords=c("longitude", "latitude"), crs=4326))

reef1_vegan_sf <- reef1_vegan %>% 
    st_as_sf(coords=c("longitude", "latitude"), crs=4326)  #create sticky geometry for lat/long

#create index map
reef1_map_index <- tm_basemap("Esri.WorldImagery") +
    tm_shape(reef1_vegan_sf, bbox = coord_sbc) +
    tm_symbols(id="location", col = "richness1", size = "richness1", scale=2, #point size corresponds to value
               palette = "inferno", contrast = c(1,0.5)) #set viridis palette to match plot
  
tmap_mode("view") #view = interactive
reef1_map_index
```

Community tab troubleshooting
```{r}
#generate reactive summary data
reef1_summary_community <- reef1_tidy %>%
    filter(value > "0") %>% #filter out species not present
    filter(location=="Naples", #filter for location of interest
           str_detect(orientation,pattern="l")) %>% #filter for orientation of interest
    group_by(phylum) %>% #group by phylum
    summarize(mean_count = mean(value), #get the mean count
              median_count = median(value), #get the median count
              sd_count = sd(value), #get the s.d. count
              iqr = IQR(value), #get the interquartile range for the count
              sample_size = n())

#generate plot
  ggplot(data=reef1_summary_community, aes(x=reorder(phylum, sample_size), #order bars by descending value
                                  y=sample_size, 
                                  fill=phylum)) + #color bars by phylum identity
    geom_col() +
    scale_fill_manual(values=pal, limits=names(pal), guide=FALSE) + #color bars by phylum color palette, remove legend
    coord_flip() +
    ylab(paste("Number of plots")) +
    xlab("Phylum") +
    theme_minimal() +
    theme(text = element_text(size = 15))
```


```{r}
#Sankey diagram
#Prep data
reef_top <- reactive({
  reef_summary_community() %>% 
  group_by(phylum) %>% 
  tally(sample_size) %>% 
  top_n(input$sankeynumber)
})

reef_sankey <- reactive({
  reef_tidy %>%
  filter(value > "0") %>% #filter out species not present
  filter(location==input$locationselect, #filter for location of interest
          str_detect(orientation,pattern=input$orientationselect)) %>% 
  group_by(phylum, species) %>%
  summarize(`mean abundance` = mean(value)) %>% 
  filter(phylum %in% c(reef_top()$phylum)) %>% 
  select(phylum, species, `mean abundance`)
})

reef_names <- reactive({
  reef_sankey() %>% 
  select(phylum, species)
})

node_names <- reactive({
  factor(sort(unique(as.character(unname(unlist(reef_names()))))))
})

nodes <- reactive({
  data.frame(name = node_names())
})

links <- reactive({
  data.frame(source = match(reef_sankey()$phylum, node_names()) - 1,
             target = match(reef_sankey()$species, node_names()) - 1,
             value = reef_sankey()$`mean abundance`,
             group = reef_sankey()$phylum)
})

#Set color palette that can be recognized by sankeyNetwork
my_color <- 'd3.scaleOrdinal() .domain(["Annelida","Arthropoda", "Chlorophyta","Chordata","Cnidaria","Echinodermata","Ectoprocta","Fish","Heterokontophyta","Mollusca","Phoronida","Porifera","Rhodophyta"]) .range(["#D2691E", "#CDCDB4", "#3CB371", "#EE9A00","#6CA6CD", "#FF6347", "#F4A460", "#CD3700", "#6B8E23", "#708090", "#FAFAD2","#EEDD82", "#DB7093"])'

#Sankey diagram
output$sankey_plot <- renderSankeyNetwork({
  sankeyNetwork(Links = links(), Nodes = nodes(),
              Source = "source", Target = "target",
              Value = "value", NodeID = "name",
              fontSize = 12, nodeWidth = 30,
              colourScale = my_color,
              LinkGroup="group", NodeGroup = NULL)
})

```


# TO DO:
- group all of the common names together (like anemones, bryozoans)
- fix Community tab
